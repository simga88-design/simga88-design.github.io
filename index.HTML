<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR 코드 출입 확인 시스템</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        #reader { width: 90%; max-width: 500px; margin: 20px auto; border: 2px solid #ccc; border-radius: 8px; overflow: hidden; }
        #result { margin: 20px; padding: 20px; text-align: center; font-size: 1.5em; font-weight: bold; border-radius: 8px; display: none; color: white; }
        .success { background-color: #28a745; }
        .duplicate { background-color: #ffc107; color: black; }
        .error { background-color: #dc3545; }
        h1, p { text-align: center; }
    </style>
</head>
<body>
    <h1>자살예방의 날 특강</h1>
    <p>참석자의 QR코드를 카메라에 인식시켜주세요.</p>
    <div id="reader"></div>
    <div id="result"></div>

    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

    <script>
        // =======================================================================
        // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
        // 여기에 2단계에서 복사한 본인의 웹 앱(Apps Script) URL을 붙여넣으세요!
        const SCRIPT_URL = "여기에 2단계에서 복사한 웹 앱 URL을 붙여넣으세요";
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
        // =======================================================================

        const resultDiv = document.getElementById('result');
        let isProcessing = false; // 연속적인 스캔으로 인한 중복 처리를 방지하기 위한 변수

        // 스캔에 성공했을 때 실행될 함수
        function onScanSuccess(decodedText, decodedResult) {
            if (isProcessing) return; // 만약 이전 스캔이 아직 처리 중이라면, 새로운 스캔을 무시합니다.
            
            isProcessing = true; // 처리 상태를 '진행 중'으로 변경합니다.
            
            // 성공적으로 스캔되면, 잠시 카메라 스캔을 멈춥니다.
            html5QrcodeScanner.pause();

            resultDiv.style.display = 'block';
            resultDiv.className = '';
            resultDiv.textContent = '확인 중...';

            // Apps Script 웹 앱(백엔드)으로 스캔된 데이터를 보내 요청합니다.
            fetch(`${SCRIPT_URL}?id=${decodedText}`)
                .then(response => response.json()) // 응답을 JSON 형태로 변환합니다.
                .then(data => {
                    // 백엔드에서 받은 메시지를 화면에 표시합니다.
                    resultDiv.textContent = data.message;
                    if (data.status === 'success') {
                        resultDiv.classList.add('success'); // 성공(초록색)
                    } else if (data.status === 'duplicate') {
                        resultDiv.classList.add('duplicate'); // 중복(노란색)
                    } else {
                        resultDiv.classList.add('error'); // 오류(빨간색)
                    }
                })
                .catch(error => {
                    // 통신 중 문제가 발생하면 오류 메시지를 표시합니다.
                    resultDiv.textContent = '시스템 연결 오류 발생';
                    resultDiv.classList.add('error');
                    console.error('오류:', error); // 개발자 확인을 위해 콘솔에 오류 기록
                })
                .finally(() => {
                    // 3초가 지나면, 결과 메시지를 다시 숨기고 카메라 스캔을 재개합니다.
                    setTimeout(() => {
                        resultDiv.style.display = 'none';
                        isProcessing = false; // 처리 상태를 '완료'로 변경하여 다음 스캔을 준비합니다.
                        html5QrcodeScanner.resume();
                    }, 3000);
                });
        }

        // 스캔에 실패했을 때 실행될 함수 (여기서는 특별한 동작을 하지 않음)
        function onScanFailure(error) {
            // 이 부분은 카메라가 QR코드를 찾지 못할 때 계속해서 호출됩니다.
        }

        // QR코드 스캐너 객체를 생성합니다.
        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", // 스캐너를 표시할 HTML 요소의 ID
            { fps: 10, qrbox: 250 }, // 초당 10프레임, 스캔 영역(네모 박스) 크기는 250px
            false // 상세 로그 표시 안 함
        );
        
        // 스캐너를 화면에 나타내고 스캔을 시작합니다.
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        // 예시: Android 스튜디오의 WebView 설정
WebSettings. webSettings = webView.getSettings();
webSettings.setJavaScriptEnabled(true); // 자바스크립트 허용
webSettings.setAllowFileAccess(true); // 파일 접근 허용

// API 레벨 16 이상에서 로컬 파일 접근을 허용하는 중요한 설정
webSettings.setAllowFileAccessFromFileURLs(true);
    </script>
</body>
</html>